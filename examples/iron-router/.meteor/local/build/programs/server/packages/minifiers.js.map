{"version":3,"file":"/packages/minifiers.js","sources":["minifiers/minification.js","minifiers/minifiers.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AACA,qC;AACA,2B;AACA,wB;AACA,E;;AAEA,mC;AACA,yC;AACA,E;;AAEA,iC;AACA,e;;AAEA,2D;AACA,6C;AACA,G;;AAEA,a;AACA,E;;AAEA,4B;AACA,wB;AACA,uD;AACA,c;AACA,E;;AAEA,kB;;AAEA,mC;AACA,iC;AACA,E;;AAEA,kC;AACA,6D;AACA,E;;AAEA,iC;AACA,0D;AACA,e;AACA,0B;AACA,gB;AACA,E;;AAEA,oC;AACA,oE;;AAEA,uC;AACA,e;AACA,0B;AACA,gB;AACA,E;;AAEA,mC;AACA,+D;AACA,E;;AAEA,qC;AACA,mE;AACA,E;;AAEA,mC;AACA,gE;AACA,e;AACA,0B;AACA,gB;AACA,E;;AAEA,qC;AACA,iB;AACA,yB;AACA,kB;AACA,qC;AACA,e;AACA,8B;AACA,gB;AACA,E;;AAEA,oC;AACA,gC;;AAEA,yD;AACA,e;AACA,qB;AACA,gB;AACA,E;;AAEA,gC;AACA,iC;AACA,+B;AACA,S;;AAEA,kD;AACA,e;AACA,iC;AACA,gB;AACA,E;;AAEA,uC;AACA,gD;AACA,e;AACA,iC;AACA,gB;AACA,E;;AAEA,gC;AACA,gC;AACA,+B;;AAEA,0D;AACA,yD;AACA,qD;AACA,wC;AACA,4C;AACA,8C;AACA,K;AACA,uD;AACA,e;AACA,qB;AACA,gB;AACA,E;;AAEA,6C;AACA,yB;;AAEA,4C;AACA,iC;AACA,uD;AACA,gC;AACA,iB;AACA,kC;AACA,O;AACA,uD;AACA,gC;AACA,iB;AACA,kC;AACA,O;AACA,G;AACA,kC;AACA,kE;AACA,yD;AACA,mC;AACA,E;;;;;;;;;;;;;;;;;;;;;AC7IA,wC;AACA,gD;AACA,+B;AACA,6B;AACA,oC;AACA,iC;;AAEA,Y;AACA,qB;AACA,6B;AACA,iC;AACA,oD;AACA,I;AACA,mC;AACA,6B;AACA,I;AACA,gE;AACA,2C;AACA,6B;AACA,wB;AACA,8B;AACA,4C;AACA,O;AACA,M;;AAEA,kE;AACA,6E;AACA,6E;AACA,kB;AACA,yB;AACA,+B;AACA,M;;AAEA,oC;AACA,2E;AACA,uD;AACA,uD;AACA,6D;;AAEA,+C;AACA,8E;AACA,yC;AACA,sD;AACA,W;AACA,oH;AACA,O;;AAEA,2D;AACA,iE;AACA,0B;AACA,2D;AACA,+E;AACA,0B;AACA,gB;AACA,S;;AAEA,iC;AACA,qC;AACA,O;;AAEA,gE;AACA,wE;;AAEA,+E;AACA,8E;AACA,kE;AACA,kC;AACA,iJ;AACA,O;;AAEA,O;;AAEA,wD;AACA,oC;AACA,+B;AACA,6D;AACA,O;;AAEA,kB;AACA,I;;AAEA,6E;AACA,yE;AACA,iD;AACA,+E;AACA,yC;AACA,kC;;AAEA,qC;AACA,4C;AACA,M;;AAEA,4D;AACA,wD;;AAEA,+E;AACA,gF;AACA,4E;AACA,8E;AACA,6E;AACA,gF;AACA,0E;AACA,4E;AACA,8C;AACA,yB;;AAEA,yE;AACA,wE;AACA,sC;;AAEA,gF;AACA,oC;AACA,2E;AACA,gE;AACA,yE;AACA,6D;AACA,iD;AACA,+B;AACA,4B;AACA,yC;;AAEA,sD;AACA,8E;AACA,kC;AACA,wE;AACA,8D;AACA,sE;AACA,wD;AACA,W;AACA,S;;AAEA,kC;AACA,S;AACA,O;AACA,G;AACA,E","sourcesContent":["\n// Stringifier based on css-stringify\nvar emit = function (str) {\n  return str.toString();\n};\n\nvar visit = function (node, last) {\n  return traverse[node.type](node, last);\n};\n\nvar mapVisit = function (nodes) {\n  var buf = \"\";\n\n  for (var i = 0, length = nodes.length; i < length; i++) {\n    buf += visit(nodes[i], i === length - 1);\n  }\n\n  return buf;\n};\n\nMinifyAst = function(node) {\n  return node.stylesheet\n    .rules.map(function (rule) { return visit(rule); })\n    .join('');\n};\n\nvar traverse = {};\n\ntraverse.comment = function(node) {\n  return emit('', node.position);\n};\n\ntraverse.import = function(node) {\n  return emit('@import ' + node.import + ';', node.position);\n};\n\ntraverse.media = function(node) {\n  return emit('@media ' + node.media, node.position, true)\n    + emit('{')\n    + mapVisit(node.rules)\n    + emit('}');\n};\n\ntraverse.document = function(node) {\n  var doc = '@' + (node.vendor || '') + 'document ' + node.document;\n\n  return emit(doc, node.position, true)\n    + emit('{')\n    + mapVisit(node.rules)\n    + emit('}');\n};\n\ntraverse.charset = function(node) {\n  return emit('@charset ' + node.charset + ';', node.position);\n};\n\ntraverse.namespace = function(node) {\n  return emit('@namespace ' + node.namespace + ';', node.position);\n};\n\ntraverse.supports = function(node){\n  return emit('@supports ' + node.supports, node.position, true)\n    + emit('{')\n    + mapVisit(node.rules)\n    + emit('}');\n};\n\ntraverse.keyframes = function(node) {\n  return emit('@'\n    + (node.vendor || '')\n    + 'keyframes '\n    + node.name, node.position, true)\n    + emit('{')\n    + mapVisit(node.keyframes)\n    + emit('}');\n};\n\ntraverse.keyframe = function(node) {\n  var decls = node.declarations;\n\n  return emit(node.values.join(','), node.position, true)\n    + emit('{')\n    + mapVisit(decls)\n    + emit('}');\n};\n\ntraverse.page = function(node) {\n  var sel = node.selectors.length\n    ? node.selectors.join(', ')\n    : '';\n\n  return emit('@page ' + sel, node.position, true)\n    + emit('{')\n    + mapVisit(node.declarations)\n    + emit('}');\n};\n\ntraverse['font-face'] = function(node){\n  return emit('@font-face', node.position, true)\n    + emit('{')\n    + mapVisit(node.declarations)\n    + emit('}');\n};\n\ntraverse.rule = function(node) {\n  var decls = node.declarations;\n  if (!decls.length) return '';\n\n  var selectors = node.selectors.map(function (selector) {\n    // removes universal selectors like *.class => .class\n    // removes optional whitespace around '>' and '+'\n    return selector.replace(/\\*\\./, '.')\n                   .replace(/\\s*>\\s*/g, '>')\n                   .replace(/\\s*\\+\\s*/g, '+');\n  });\n  return emit(selectors.join(','), node.position, true)\n    + emit('{')\n    + mapVisit(decls)\n    + emit('}');\n};\n\ntraverse.declaration = function(node, last) {\n  var value = node.value;\n\n  // remove optional quotes around font name\n  if (node.property === 'font') {\n    value = value.replace(/\\'[^\\']+\\'/g, function (m) {\n      if (m.indexOf(' ') !== -1)\n        return m;\n      return m.replace(/\\'/g, '');\n    });\n    value = value.replace(/\\\"[^\\\"]+\\\"/g, function (m) {\n      if (m.indexOf(' ') !== -1)\n        return m;\n      return m.replace(/\\\"/g, '');\n    });\n  }\n  // remove url quotes if possible\n  // in case it is the last declaration, we can omit the semicolon\n  return emit(node.property + ':' + value, node.position)\n         + (last ? '' : emit(';'));\n};\n\n\n","var cssParse = Npm.require('css-parse');\nvar cssStringify = Npm.require('css-stringify');\nvar path = Npm.require('path');\nvar url = Npm.require('url');\nUglifyJS = Npm.require('uglify-js');\nUglifyJSMinify = UglifyJS.minify;\n\nCssTools = {\n  parseCss: cssParse,\n  stringifyCss: cssStringify,\n  minifyCss: function (cssText) {\n    return CssTools.minifyCssAst(cssParse(cssText));\n  },\n  minifyCssAst: function (cssAst) {\n    return MinifyAst(cssAst);\n  },\n  mergeCssAsts: function (cssAsts, warnCb, shouldKeepRelPaths) {\n    var rulesPredicate = function (rules) {\n      if (! _.isArray(rules))\n        rules = [rules];\n      return function (node) {\n        return _.contains(rules, node.type);\n      }\n    };\n\n    // Simple concatenation of CSS files would break @import rules\n    // located in the beginning of a file. Before concatenation, pull them to\n    // the beginning of a new syntax tree so they always precede other rules.\n    var newAst = {\n      type: 'stylesheet',\n      stylesheet: { rules: [] }\n    };\n\n    _.each(cssAsts, function (ast) {\n      // Pick only the imports from the beginning of file ignoring @charset\n      // rules as every file is assumed to be in UTF-8.\n      var charsetRules = _.filter(ast.stylesheet.rules,\n                                  rulesPredicate(\"charset\"));\n\n      if (_.any(charsetRules, function (rule) {\n        // According to MDN, only 'UTF-8' and \"UTF-8\" are the correct encoding\n        // directives representing UTF-8.\n        return ! /^(['\"])UTF-8\\1$/.test(rule.charset);\n      })) {\n        warnCb(ast.filename, \"@charset rules in this file will be ignored as UTF-8 is the only encoding supported\");\n      }\n\n      ast.stylesheet.rules = _.reject(ast.stylesheet.rules,\n                                      rulesPredicate(\"charset\"));\n      var importCount = 0;\n      for (var i = 0; i < ast.stylesheet.rules.length; i++)\n        if (! rulesPredicate([\"import\", \"comment\"])(ast.stylesheet.rules[i])) {\n          importCount = i;\n          break;\n        }\n\n      if (! shouldKeepRelPaths) {\n        CssTools.rewriteCssUrls(ast);\n      }\n\n      var imports = ast.stylesheet.rules.splice(0, importCount);\n      newAst.stylesheet.rules = newAst.stylesheet.rules.concat(imports);\n\n      // if there are imports left in the middle of file, warn user as it might\n      // be a potential bug (imports are valid only in the beginning of file).\n      if (_.any(ast.stylesheet.rules, rulesPredicate(\"import\"))) {\n        // XXX make this an error?\n        warnCb(ast.filename, \"there are some @import rules those are not taking effect as they are required to be in the beginning of the file\");\n      }\n\n    });\n\n    // Now we can put the rest of CSS rules into new AST\n    _.each(cssAsts, function (ast) {\n      newAst.stylesheet.rules =\n        newAst.stylesheet.rules.concat(ast.stylesheet.rules);\n    });\n\n    return newAst;\n  },\n\n  // We are looking for all relative urls defined with the `url()` functional\n  // notation and rewriting them to the equivalent absolute url using the\n  // `position.source` path provided by css-parse\n  // For performance reasons this function acts by side effect by modifying the\n  // given AST without doing a deep copy.\n  rewriteCssUrls: function (ast) {\n\n    var isRelative = function(path) {\n      return path && path.charAt(0) !== '/';\n    };\n\n    _.each(ast.stylesheet.rules, function(rule, ruleIndex) {\n      var basePath = path.dirname(rule.position.source);\n\n      // Set the correct basePath based on how the linked asset will be served.\n      // XXX This is wrong. We are coupling the information about how files will\n      // be served by the web server to the information how they were stored\n      // originally on the filesystem in the project structure. Ideally, there\n      // should be some module that tells us precisely how each asset will be\n      // served but for now we are just assuming that everything that comes from\n      // a folder starting with \"/packages/\" is served on the same path as\n      // it was on the filesystem and everything else is served on root \"/\".\n      if (! basePath.match(/^\\/?packages\\//i))\n          basePath = \"/\";\n\n      _.each(rule.declarations, function(declaration, declarationIndex) {\n        var parts, resource, absolutePath, quotes, oldCssUrl, newCssUrl;\n        var value = declaration.value;\n\n        // Match css values containing some functional calls to `url(URI)` where\n        // URI is optionally quoted.\n        // Note that a css value can contains other elements, for instance:\n        //   background: top center url(\"background.png\") black;\n        // or even multiple url(), for instance for multiple backgrounds.\n        var cssUrlRegex = /url\\s*\\(\\s*(['\"]?)(.+?)\\1\\s*\\)/gi;\n        while (parts = cssUrlRegex.exec(value)) {\n          oldCssUrl = parts[0];\n          quotes = parts[1];\n          resource = url.parse(parts[2]);\n\n          // Rewrite relative paths to absolute paths.\n          // We don't rewrite urls starting with a protocol definition such as\n          // http, https, or data.\n          if (isRelative(resource.path) && resource.protocol === null) {\n            absolutePath = path.join(basePath, resource.path);\n            newCssUrl = \"url(\" + quotes + absolutePath + quotes + \")\";\n            value = value.replace(oldCssUrl, newCssUrl);\n          }\n        }\n\n        declaration.value = value;\n      });\n    });\n  }\n};\n\n"]}